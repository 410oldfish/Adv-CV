import os
import glob
from PIL import Image
from sklearn.model_selection import train_test_split

import torch
from torch.utils.data import Dataset, DataLoader
from torchvision import transforms

from config import batch_size, test_batch_size, cifar10_label_names

# Transforms 数据增强
train_transforms = transforms.Compose([
    # transforms.Resize((224, 224)),
    transforms.RandomCrop(32, padding=4),
    transforms.RandomHorizontalFlip(),
    transforms.ToTensor(),
    transforms.Normalize([0.5]*3, [0.5]*3),
])

test_transforms = transforms.Compose([
    transforms.ToTensor(),
    transforms.Normalize([0.5]*3, [0.5]*3),
])


# test_transforms = transforms.Compose([
#     transforms.Resize(256),
#     transforms.CenterCrop(224),
#     transforms.ToTensor(),
# ])

cifar10_label_keys = {v: k for k, v in cifar10_label_names.items()}

# Dataset 数据集，已经按batch划分好
class CifarDataset(Dataset):
    def __init__(self, file_list, transform=None):
        self.file_list = file_list
        self.transform = transform

    def __len__(self):
        return len(self.file_list)

    def __getitem__(self, idx):
        img_path = self.file_list[idx]
        img = Image.open(img_path)
        if self.transform:
            img = self.transform(img)
        label = img_path.split('/')[-1].split('.')[0].split('_')[0].lower()
        label = cifar10_label_keys[label]
        return img, label, img_path

# Data loader
# 训练集 & 验证集
def get_train_valid_loaders(train_dir):
    train_list = glob.glob(os.path.join(train_dir, '*.jpg'))
    train_list = [p.replace('\\', '/') for p in train_list]
    labels = [p.split('/')[-1].split('.')[0].split('_')[0] for p in train_list]
    train_list, valid_list = train_test_split(train_list, test_size=0.2, stratify=labels, random_state=42)


    train_data = CifarDataset(train_list, transform=train_transforms)
    valid_data = CifarDataset(valid_list, transform=test_transforms)

    train_loader = DataLoader(train_data, batch_size=batch_size, shuffle=True)
    valid_loader = DataLoader(valid_data, batch_size=batch_size, shuffle=False)

    return train_loader, valid_loader

# 测试集
def get_test_loader(test_dir):
    test_list = glob.glob(os.path.join(test_dir, '*.jpg'))
    test_list = [p.replace('\\', '/') for p in test_list]
    test_data = CifarDataset(test_list, transform=test_transforms)
    test_loader = DataLoader(test_data, batch_size=test_batch_size, shuffle=False)
    return test_loader

